<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flashcards Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            bg: "#0b1220",
            panel: "#111827",
            card: "#0f172a",
            accent: "#22d3ee",
            accent2: "#818cf8",
            border: "#1f2937",
          },
          boxShadow: {
            glow: "0 0 30px rgba(34, 211, 238, 0.25)",
          },
        },
      },
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Space Grotesk', 'Inter', system-ui, -apple-system, sans-serif; }
    body { background: radial-gradient(circle at 20% 20%, rgba(56,189,248,0.08), transparent 35%), radial-gradient(circle at 80% 0%, rgba(129,140,248,0.1), transparent 30%), #0b1220; }
  </style>
</head>
<body class="min-h-screen text-slate-100">
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useEffect, useState, useCallback } = React;
    const API_BASE = "php/api.php";

    const shuffleList = (list) => {
      const arr = [...list];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    };

    const fetchJson = async (url, options = {}) => {
      const res = await fetch(url, options);
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.error || "Erro ao comunicar com o servidor.");
      }
      return data;
    };

    const Status = ({ status }) => {
      if (!status) return null;
      const colors = status.type === "error" ? "text-rose-300 border-rose-500/40 bg-rose-500/10" : "text-teal-200 border-teal-500/30 bg-teal-500/5";
      return (
        <div className={"mt-3 text-sm border rounded-md px-3 py-2 " + colors}>
          {status.message}
        </div>
      );
    };

    const Header = () => (
      <header className="py-6 px-6">
        <div className="max-w-6xl mx-auto flex items-center justify-between">
          <div>
            <p className="text-sm tracking-widest text-accent font-semibold uppercase">Modo Estudo</p>
            <h1 className="text-3xl font-semibold mt-1 text-slate-50">Flashcards Tech</h1>
            <p className="text-slate-400 text-sm">Organize grupos, crie cards e treine em tela cheia.</p>
          </div>
          <div className="flex gap-2">
            <span className="px-3 py-1 rounded-full border border-slate-700 text-xs text-slate-300 bg-slate-800/40">React + Tailwind (CDN)</span>
            <span className="px-3 py-1 rounded-full border border-slate-700 text-xs text-slate-300 bg-slate-800/40">Modo dark</span>
          </div>
        </div>
      </header>
    );

    const GroupForm = ({ onCreated }) => {
      const [name, setName] = useState("");
      const [description, setDescription] = useState("");
      const [loading, setLoading] = useState(false);
      const [status, setStatus] = useState(null);

      const submit = async (e) => {
        e.preventDefault();
        if (!name.trim()) {
          setStatus({ type: "error", message: "Dê um nome ao grupo." });
          return;
        }
        setLoading(true);
        setStatus(null);
        try {
          const data = await fetchJson(API_BASE + "?action=create_group", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, description }),
          });
          setName("");
          setDescription("");
          setStatus({ type: "success", message: "Grupo criado!" });
          onCreated(data.group);
        } catch (err) {
          setStatus({ type: "error", message: err.message });
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="bg-panel/70 border border-slate-800 rounded-2xl p-4 shadow-glow">
          <div className="flex items-center justify-between mb-3">
            <div>
              <p className="text-xs uppercase tracking-[0.2em] text-slate-400">Novo Grupo</p>
              <h2 className="text-lg font-semibold text-slate-50">Monte trilhas de estudo</h2>
            </div>
            <div className="h-10 w-10 rounded-full border border-slate-700 flex items-center justify-center text-accent">+</div>
          </div>
          <form className="space-y-3" onSubmit={submit}>
            <div>
              <label className="text-sm text-slate-300">Nome</label>
              <input
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="mt-1 w-full rounded-lg bg-card border border-slate-800 focus:border-accent focus:ring-2 focus:ring-accent/30 px-3 py-2 text-slate-100"
                placeholder="Ex: Frontend, Inglês, Certificação..."
              />
            </div>
            <div>
              <label className="text-sm text-slate-300">Descrição (opcional)</label>
              <textarea
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                className="mt-1 w-full rounded-lg bg-card border border-slate-800 focus:border-accent focus:ring-2 focus:ring-accent/30 px-3 py-2 text-slate-100"
                rows="2"
                placeholder="O que você vai treinar aqui?"
              />
            </div>
            <button
              type="submit"
              disabled={loading}
              className="w-full py-2.5 rounded-lg bg-gradient-to-r from-accent to-accent2 text-slate-900 font-semibold shadow-glow disabled:opacity-70"
            >
              {loading ? "Criando..." : "Criar grupo"}
            </button>
            <Status status={status} />
          </form>
        </div>
      );
    };

    const GroupList = ({ groups, selectedId, onSelect }) => (
      <div className="bg-panel/70 border border-slate-800 rounded-2xl p-4">
        <div className="flex items-center justify-between mb-3">
          <div>
            <p className="text-xs uppercase tracking-[0.2em] text-slate-400">Grupos</p>
            <h2 className="text-lg font-semibold text-slate-50">Suas coleções</h2>
          </div>
          <span className="text-xs text-slate-400">{groups.length} ativo(s)</span>
        </div>
        <div className="grid grid-cols-1 gap-3 max-h-72 overflow-auto pr-1">
          {groups.map((g) => (
            <button
              key={g.id}
              onClick={() => onSelect(g)}
              className={
                "w-full text-left p-3 rounded-xl border transition-all " +
                (selectedId === g.id
                  ? "bg-gradient-to-r from-accent/20 to-accent2/20 border-accent/50 shadow-glow"
                  : "bg-card border-slate-800 hover:border-slate-700 hover:bg-slate-900")
              }
            >
              <div className="flex items-center justify-between">
                <span className="text-slate-100 font-semibold">{g.name}</span>
                {selectedId === g.id && <span className="text-xs text-accent">ativo</span>}
              </div>
              {g.description && <p className="text-sm text-slate-400 mt-1">{g.description}</p>}
            </button>
          ))}
          {groups.length === 0 && <p className="text-sm text-slate-500">Nenhum grupo ainda.</p>}
        </div>
      </div>
    );

    const CardForm = ({ group, onCreated }) => {
      const [question, setQuestion] = useState("");
      const [answer, setAnswer] = useState("");
      const [file, setFile] = useState(null);
      const [loading, setLoading] = useState(false);
      const [status, setStatus] = useState(null);

      const submit = async (e) => {
        e.preventDefault();
        if (!group) {
          setStatus({ type: "error", message: "Escolha um grupo antes." });
          return;
        }
        if (!question.trim()) {
          setStatus({ type: "error", message: "Pergunta obrigatória." });
          return;
        }
        if (!answer.trim() && !file) {
          setStatus({ type: "error", message: "Informe uma resposta ou imagem." });
          return;
        }
        setLoading(true);
        setStatus(null);
        try {
          const form = new FormData();
          form.append("group_id", group.id);
          form.append("question", question);
          form.append("answer", answer);
          if (file) form.append("answer_image", file);

          const res = await fetch(API_BASE + "?action=create_card", {
            method: "POST",
            body: form,
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Erro ao salvar.");
          setQuestion("");
          setAnswer("");
          setFile(null);
          onCreated(data.card);
          setStatus({ type: "success", message: "Card criado!" });
        } catch (err) {
          setStatus({ type: "error", message: err.message });
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="bg-panel/70 border border-slate-800 rounded-2xl p-4">
          <div className="flex items-center justify-between mb-3">
            <div>
              <p className="text-xs uppercase tracking-[0.2em] text-slate-400">Novo Card</p>
              <h2 className="text-lg font-semibold text-slate-50">Pergunta & resposta</h2>
            </div>
            <span className="text-xs text-slate-400">{group ? group.name : "Escolha um grupo"}</span>
          </div>
          <form className="space-y-3" onSubmit={submit}>
            <div>
              <label className="text-sm text-slate-300">Pergunta</label>
              <input
                value={question}
                onChange={(e) => setQuestion(e.target.value)}
                className="mt-1 w-full rounded-lg bg-card border border-slate-800 focus:border-accent focus:ring-2 focus:ring-accent/30 px-3 py-2 text-slate-100"
                placeholder="O que deseja lembrar?"
              />
            </div>
            <div>
              <label className="text-sm text-slate-300">Resposta (texto)</label>
              <textarea
                value={answer}
                onChange={(e) => setAnswer(e.target.value)}
                className="mt-1 w-full rounded-lg bg-card border border-slate-800 focus:border-accent focus:ring-2 focus:ring-accent/30 px-3 py-2 text-slate-100"
                rows="3"
                placeholder="Escreva a resposta ou use uma imagem."
              />
            </div>
            <div>
              <label className="text-sm text-slate-300">Resposta em imagem (opcional)</label>
              <input
                type="file"
                accept="image/*"
                onChange={(e) => setFile(e.target.files?.[0])}
                className="mt-1 w-full text-sm text-slate-300 file:mr-3 file:py-2 file:px-3 file:rounded-md file:border-0 file:bg-accent/20 file:text-slate-50 file:cursor-pointer bg-card border border-slate-800 rounded-lg"
              />
              <p className="text-xs text-slate-500 mt-1">Imagens ocupam todo o card na resposta.</p>
            </div>
            <button
              type="submit"
              disabled={loading}
              className="w-full py-2.5 rounded-lg bg-gradient-to-r from-accent to-accent2 text-slate-900 font-semibold shadow-glow disabled:opacity-70"
            >
              {loading ? "Salvando..." : "Salvar card"}
            </button>
            <Status status={status} />
          </form>
        </div>
      );
    };

    const FlashcardViewer = ({ cards, currentIndex, onPrev, onNext, shuffleOn, onShuffleToggle }) => {
      const [showAnswer, setShowAnswer] = useState(false);

      useEffect(() => {
        setShowAnswer(false);
      }, [currentIndex]);

      const card = cards[currentIndex];

      if (!cards.length) {
        return (
          <div className="flex-1 bg-panel/60 border border-dashed border-slate-800 rounded-3xl min-h-[70vh] flex items-center justify-center text-slate-400">
            Adicione cards para estudar.
          </div>
        );
      }

      return (
        <div className="flex-1">
          <div className="flex items-center justify-between mb-3 px-1">
            <div className="flex items-center gap-2">
              <span className="text-xs uppercase tracking-[0.2em] text-slate-400">Estudo</span>
              <span className="px-3 py-1 rounded-full bg-slate-800/70 border border-slate-700 text-xs text-slate-200">
                {currentIndex + 1} / {cards.length}
              </span>
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => onShuffleToggle(!shuffleOn)}
                className={"px-3 py-1.5 rounded-lg border text-sm transition " + (shuffleOn ? "border-accent/60 text-accent bg-accent/10" : "border-slate-700 text-slate-200 bg-slate-800/60 hover:border-slate-600")}
              >
                Embaralhar {shuffleOn ? "✔" : ""}
              </button>
              <button
                onClick={onPrev}
                className="px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-800/60 text-slate-200 hover:border-slate-600"
              >
                Anterior
              </button>
              <button
                onClick={onNext}
                className="px-3 py-1.5 rounded-lg border border-slate-700 bg-slate-800/60 text-slate-200 hover:border-slate-600"
              >
                Próximo
              </button>
            </div>
          </div>

          <div className="relative bg-card border border-slate-800 rounded-3xl min-h-[70vh] overflow-hidden shadow-glow flex flex-col">
            <div className="absolute inset-0 pointer-events-none bg-gradient-to-br from-accent/5 via-transparent to-accent2/10"></div>
            <div className="flex-1 flex items-center justify-center p-10">
              <div className="w-full h-full">
                {!showAnswer ? (
                  <div className="h-full flex flex-col items-center justify-center text-center">
                    <p className="text-slate-400 uppercase tracking-[0.3em] text-xs mb-3">Pergunta</p>
                    <p className="text-3xl font-semibold text-slate-50 leading-tight">{card.question}</p>
                  </div>
                ) : (
                  <div className="h-full w-full rounded-2xl overflow-hidden border border-slate-800 bg-slate-900/60 flex items-center justify-center">
                    {card.answer_image ? (
                      <img src={card.answer_image} alt="Resposta em imagem" className="w-full h-full object-cover" />
                    ) : (
                      <div className="p-8 text-center">
                        <p className="text-slate-400 uppercase tracking-[0.3em] text-xs mb-3">Resposta</p>
                        <p className="text-2xl font-semibold text-slate-50 leading-tight whitespace-pre-line">{card.answer || "Sem resposta de texto."}</p>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
            <div className="p-6 border-t border-slate-800 bg-slate-900/60 flex items-center justify-between">
              <div className="text-sm text-slate-400">Clique para virar e revelar.</div>
              <button
                onClick={() => setShowAnswer((v) => !v)}
                className="px-4 py-2 rounded-lg bg-gradient-to-r from-accent to-accent2 text-slate-900 font-semibold shadow-glow"
              >
                {showAnswer ? "Mostrar pergunta" : "Ver resposta"}
              </button>
            </div>
          </div>
        </div>
      );
    };

    const App = () => {
      const [groups, setGroups] = useState([]);
      const [selectedGroup, setSelectedGroup] = useState(null);
      const [cards, setCards] = useState([]);
      const [displayCards, setDisplayCards] = useState([]);
      const [currentIndex, setCurrentIndex] = useState(0);
      const [shuffleOn, setShuffleOn] = useState(true);
      const [status, setStatus] = useState(null);
      const [loadingCards, setLoadingCards] = useState(false);

      const loadGroups = useCallback(async () => {
        try {
          const data = await fetchJson(API_BASE + "?action=list_groups");
          setGroups(data.groups || []);
          if (!selectedGroup && data.groups?.length) {
            setSelectedGroup(data.groups[0]);
          }
        } catch (err) {
          setStatus({ type: "error", message: err.message });
        }
      }, [selectedGroup]);

      const loadCards = useCallback(async (groupId) => {
        if (!groupId) return;
        setLoadingCards(true);
        try {
          const data = await fetchJson(API_BASE + "?action=list_cards&group_id=" + groupId);
          setCards(data.cards || []);
          setCurrentIndex(0);
        } catch (err) {
          setStatus({ type: "error", message: err.message });
        } finally {
          setLoadingCards(false);
        }
      }, []);

      useEffect(() => {
        loadGroups();
      }, [loadGroups]);

      useEffect(() => {
        if (selectedGroup) {
          loadCards(selectedGroup.id);
        } else {
          setCards([]);
        }
      }, [selectedGroup, loadCards]);

      useEffect(() => {
        const ordered = shuffleOn ? shuffleList(cards) : [...cards];
        setDisplayCards(ordered);
        setCurrentIndex(0);
      }, [cards, shuffleOn]);

      const handleSelectGroup = (group) => {
        setSelectedGroup(group);
        setStatus(null);
      };

      const handlePrev = () => {
        setCurrentIndex((idx) => (idx - 1 + displayCards.length) % displayCards.length);
      };
      const handleNext = () => {
        setCurrentIndex((idx) => (idx + 1) % displayCards.length);
      };

      return (
        <div className="pb-10">
          <Header />
          <div className="max-w-6xl mx-auto px-6">
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-5">
              <div className="space-y-4">
                <GroupForm onCreated={(g) => { setGroups((prev) => [g, ...prev]); setSelectedGroup(g); }} />
                <GroupList groups={groups} selectedId={selectedGroup?.id} onSelect={handleSelectGroup} />
                <CardForm group={selectedGroup} onCreated={(card) => setCards((prev) => [card, ...prev])} />
                <Status status={status} />
              </div>
              <div className="lg:col-span-2">
                {loadingCards ? (
                  <div className="flex items-center justify-center min-h-[70vh] bg-panel/70 border border-slate-800 rounded-3xl">
                    <p className="text-slate-400">Carregando cards...</p>
                  </div>
                ) : (
                  <FlashcardViewer
                    cards={displayCards}
                    currentIndex={currentIndex}
                    onPrev={handlePrev}
                    onNext={handleNext}
                    shuffleOn={shuffleOn}
                    onShuffleToggle={setShuffleOn}
                  />
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
